<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <title>Lịch hẹn của Kỹ thuật viên</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link rel="shortcut icon" th:href="@{/assets/img/favicon.svg}">
  <!-- Bootstrap min.css -->
  <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
  <!-- All Min Css -->
  <link rel="stylesheet" th:href="@{/assets/css/all.min.css}">
  <!-- Animate.css -->
  <link rel="stylesheet" th:href="@{/assets/css/animate.css}">
  <!-- Magnific Popup.css -->
  <link rel="stylesheet" th:href="@{/assets/css/magnific-popup.css}">
  <!-- MeanMenu.css -->
  <link rel="stylesheet" th:href="@{/assets/css/meanmenu.css}">
  <!-- Swiper Bundle.css -->
  <link rel="stylesheet" th:href="@{/assets/css/swiper-bundle.min.css}">
  <!-- Nice Select.css -->
  <link rel="stylesheet" th:href="@{/assets/css/nice-select.css}">
  <!-- Icomon.css -->
  <link rel="stylesheet" th:href="@{/assets/css/icomon.css}">
  <!-- Main.css -->
  <link rel="stylesheet" th:href="@{/assets/css/main.css}">
  <style>
    .table {
      max-width: 100%;
      margin: auto;
    }
    .time-cell {
      min-height: 120px;
    }
    .appointment-box {
      background-color: #f8f9fa;
      border-left: 4px solid #0d6efd;
      padding: 5px;
      margin-bottom: 5px;
      border-radius: 4px;
      text-align: left;
    }
    .appointment-box small {
      display: block;
      font-size: 0.8em;
      color: #555;
    }
  </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="container mt-4">
  <h1 class="mb-4">Lịch hẹn của tôi</h1>

  <div th:if="${error}" class="alert alert-danger" th:text="${error}"></div>
  <div th:if="${success}" class="alert alert-success" th:text="${success}"></div>

  <table class="table table-bordered text-center align-middle">
    <thead class="table-dark">
    <tr>
      <th>Khung giờ</th>
      <th>Thứ 2</th>
      <th>Thứ 3</th>
      <th>Thứ 4</th>
      <th>Thứ 5</th>
      <th>Thứ 6</th>
      <th>Thứ 7</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="slot : ${timeSlots}">
      <th th:text="${slot.label}"></th>
      <td th:each="day : ${#numbers.sequence(1,6)}" class="time-cell">
        <div th:each="appointment : ${appointments}"
             th:if="${#temporals.dayOfWeek(appointment.startTime) == day
                            and #temporals.format(appointment.startTime, 'HH:mm') >= slot.startTime
                            and #temporals.format(appointment.startTime, 'HH:mm') < slot.endTime}">
          <div class="appointment-box d-flex flex-column gap-2 align-items-start">
            <strong th:text="${appointment.customer.name}">Khách</strong>
            <small th:text="${appointment.customer.phoneNumber}">Số điện thoại</small>
            <small th:text="${appointment.service.name}">Dịch vụ</small>
            <small th:text="${#temporals.format(appointment.startTime, 'HH:mm')} + ' - ' + ${#temporals.format(appointment.endTime, 'HH:mm')}">Giờ</small>

            <span th:if="${appointment.status.name() == 'cho_xac_nhan'}" class="badge bg-warning text-dark">Chờ xác nhận</span>
            <span th:if="${appointment.status.name() == 'da_xac_nhan'}" class="badge bg-primary">Đã xác nhận</span>
            <span th:if="${appointment.status.name() == 'da_huy'}" class="badge bg-danger">Đã hủy</span>
            <span th:if="${appointment.status.name() == 'da_hoan_thanh'}" class="badge bg-success">Đã hoàn thành</span>

            <div th:if="${appointment.status.name() == 'cho_xac_nhan'}" class="d-flex gap-2 w-100 justify-content-between">
              <div class="flex-fill">
                <button type="button" class="btn btn-sm btn-danger w-100 cancel-with-reason-btn"
                        data-bs-toggle="modal"
                        data-bs-target="#reasonModal"
                        th:data-appointment-id="${appointment.id}"
                        th:data-week-offset="${weekOffset}">
                  Hủy
                </button>
              </div>
            </div>

            <div th:if="${appointment.status.name() == 'da_xac_nhan'}" class="d-flex gap-2 w-100 justify-content-between">
              <div class="flex-fill">
                <button type="button" class="btn btn-sm btn-danger w-100 cancel-with-reason-btn"
                        data-bs-toggle="modal"
                        data-bs-target="#reasonModal"
                        th:data-appointment-id="${appointment.id}"
                        th:data-week-offset="${weekOffset}">
                  Hủy
                </button>
              </div>

              <form th:action="@{/technician/appointments/complete}" method="post"
                    onsubmit="return confirm('Xác nhận đã hoàn thành lịch hẹn này?');" class="flex-fill">
                <input type="hidden" name="appointmentId" th:value="${appointment.id}" />
                <input type="hidden" name="weekOffset" th:value="${weekOffset}" />
                <button type="submit" class="btn btn-sm btn-primary w-100">Hoàn thành</button>
              </form>
            </div>
          </div>
        </div>
      </td>
    </tr>
    </tbody>
  </table>

</div>
<div class="d-flex justify-content-center mt-4">
  <a th:href="@{/technician/appointments(weekOffset=${weekOffset - 1})}" class="btn btn-outline-primary me-2">
    &laquo; Tuần trước
  </a>
  <span class="align-self-center fw-bold">
        <span th:text="${#temporals.format(startOfWeek, 'dd/MM/yyyy')}"></span>
        &nbsp;-&nbsp;
        <span th:text="${#temporals.format(startOfWeek.plusDays(5), 'dd/MM/yyyy')}"></span>
    </span>
  <a th:href="@{/technician/appointments(weekOffset=${weekOffset + 1})}" class="btn btn-outline-primary ms-2">
    Tuần sau &raquo;
  </a>
</div>


<div class="modal fade" id="adminModal" tabindex="-1" aria-labelledby="adminModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="adminModalLabel">Thông báo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <div class="modal-body" id="adminModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="reasonModal" tabindex="-1" aria-labelledby="reasonModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reasonModalLabel">Nhập lý do hủy lịch hẹn</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
      </div>
      <form id="submitTechnicianCancelForm" th:action="@{/technician/appointments/cancel}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <input type="hidden" name="appointmentId" id="modalReasonAppointmentId">
        <input type="hidden" name="weekOffset" id="modalReasonWeekOffset">

        <div class="modal-body">
          <p>Vui lòng nhập lý do bạn muốn hủy lịch hẹn này:</p>
          <div class="mb-3">
            <label for="cancellationReasonInput" class="form-label">Lý do hủy (Bắt buộc)</label>
            <textarea class="form-control" id="cancellationReasonInput" name="cancellationReason" rows="4" placeholder="Ví dụ: Khách hàng yêu cầu, tôi có việc đột xuất..." required></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="submit" class="btn btn-danger">Xác nhận Hủy</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div th:replace="~{fragments/footer :: footer}"></div>
<!-- JavaScript Files -->
<!--<< All JS Plugins >>-->
<script src="/assets/js/jquery-3.7.1.min.js"></script>
<!--<< Viewport Js >>-->
<script src="/assets/js/viewport.jquery.js"></script>
<!--<< Bootstrap Js >>-->
<script src="/assets/js/bootstrap.bundle.min.js"></script>
<!--<< nice-selec Js >>-->
<script src="/assets/js/jquery.nice-select.min.js"></script>
<!--<< Waypoints Js >>-->
<script src="/assets/js/jquery.waypoints.js"></script>
<!--<< Counterup Js >>-->
<script src="/assets/js/jquery.counterup.min.js"></script>
<!--<< Swiper Slider Js >>-->
<script src="/assets/js/swiper-bundle.min.js"></script>
<!--<< MeanMenu Js >>-->
<script src="/assets/js/jquery.meanmenu.min.js"></script>
<!--<< Magnific Popup Js >>-->
<script src="/assets/js/jquery.magnific-popup.min.js"></script>
<!--<< Wow Animation Js >>-->
<script src="/assets/js/wow.min.js"></script>
<!--<< Main.js >>-->
<script src="/assets/js/main.js"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const adminModal = new bootstrap.Modal(document.getElementById('adminModal'));
    const adminModalBody = document.getElementById('adminModalBody');
    const reasonModal = document.getElementById('reasonModal');
    const cancellationReasonTextarea = document.getElementById('cancellationReasonInput');
    const submitTechnicianCancelForm = document.getElementById('submitTechnicianCancelForm');

    let currentAppointmentId = null;
    let currentWeekOffset = null;
    let csrfToken = null;
    let csrfParameterName = null;

    // Lấy CSRF token
    const csrfMeta = document.querySelector('meta[name="_csrf"]');
    if (csrfMeta) {
      csrfToken = csrfMeta.getAttribute('content');
      csrfParameterName = csrfMeta.getAttribute('name');
    } else {
      const csrfInput = document.querySelector('input[name="_csrf"]');
      if (csrfInput) {
        csrfToken = csrfInput.value;
        csrfParameterName = csrfInput.name;
      }
    }

    if (reasonModal) {
      reasonModal.addEventListener('show.bs.modal', function (event) {
        const button = event.relatedTarget;
        currentAppointmentId = button.getAttribute('data-appointment-id');
        currentWeekOffset = button.getAttribute('data-week-offset') || '0';

        if (cancellationReasonTextarea) {
          cancellationReasonTextarea.value = '';
          cancellationReasonTextarea.focus();
        }

      });
    }

    if (submitTechnicianCancelForm) {
      submitTechnicianCancelForm.addEventListener('submit', function(event) {
        event.preventDefault();

        const reason = cancellationReasonTextarea ? cancellationReasonTextarea.value.trim() : '';

        if (reason === '') {
          alert('Vui lòng nhập lý do hủy lịch hẹn.');
          if (cancellationReasonTextarea) {
            cancellationReasonTextarea.focus();
          }
          return;
        }

        if (!currentAppointmentId) {
          alert('Lỗi: Không tìm thấy ID lịch hẹn. Vui lòng đóng modal và thử lại.');
          console.error("Lỗi: ID lịch hẹn trong modal bị rỗng khi submit form hủy.");
          return;
        }

        // Tạo FormData để đóng gói dữ liệu
        const formData = new FormData();
        formData.append('appointmentId', currentAppointmentId);
        formData.append('weekOffset', currentWeekOffset);
        formData.append('cancellationReason', reason);

        // Thêm CSRF token vào FormData
        if (csrfParameterName && csrfToken) {
          formData.append(csrfParameterName, csrfToken);
        } else {
          console.warn("CSRF Token hoặc Parameter Name không tìm thấy cho Technician. Có thể gây lỗi.");
        }

        // Gửi request bằng Fetch API
        fetch(this.action, {
          method: 'POST',
          body: formData
        })
                .then(response => {
                  if (response.redirected) {
                    window.location.href = response.url;
                  } else if (response.ok) {
                    return response.text().then(text => {
                      adminModalBody.textContent = "Hủy lịch hẹn thành công!";
                      adminModal.show();
                      const modalInstance = bootstrap.Modal.getInstance(reasonModal);
                      if (modalInstance) {
                        modalInstance.hide();
                      }
                    });
                  } else {
                    console.error('Lỗi khi hủy lịch hẹn (Technician):', response.status, response.statusText);
                    return response.text().then(text => {
                      adminModalBody.textContent = 'Đã xảy ra lỗi khi hủy lịch hẹn: ' + text;
                      adminModal.show();
                      const modalInstance = bootstrap.Modal.getInstance(reasonModal);
                      if (modalInstance) {
                        modalInstance.hide();
                      }
                      throw new Error(text);
                    });
                  }
                })
                .catch(error => {
                  console.error('Lỗi Fetch API (Technician):', error);
                  adminModalBody.textContent = 'Đã xảy ra lỗi kết nối: ' + error.message;
                  adminModal.show();
                })
                .finally(() => {
                  const modalInstance = bootstrap.Modal.getInstance(reasonModal);
                  if (modalInstance) {
                    modalInstance.hide();
                  }
                });
      });
    }
  });
</script>
</body>
</html>