<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/admin_layout}">
<head>
    <title layout:title="Quản lý Xe & Khách hàng"></title>
    <th:block layout:fragment="css_additional">
        <style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                background-color: #f8f9fa;
                color: #212529;
                margin: 0;
                padding: 0;
            }

            .container {
                max-width: 1200px;
                margin: auto;
                background-color: #fff;
                padding: 30px;
                border-radius: 8px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            }

            h1 {
                color: #0056b3;
                text-align: center;
                margin-bottom: 25px;
            }

            #searchInput {
                width: 100%;
                padding: 12px;
                margin-bottom: 20px;
                border: 1px solid #ced4da;
                border-radius: 5px;
                font-size: 16px;
                box-sizing: border-box;
            }

            table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }

            th, td {
                padding: 12px 15px;
                border: 1px solid #dee2e6;
                text-align: left;
                vertical-align: middle;
            }

            thead th {
                background-color: #0056b3;
                color: #fff;
                font-weight: 600;
            }

            tbody tr:nth-child(even) {
                background-color: #f2f2f2;
            }

            tbody tr:hover {
                background-color: #e9ecef;
            }

            .message {
                text-align: center;
                padding: 15px;
                font-size: 16px;
                border-radius: 5px;
                margin-bottom: 15px;
                display: block;
            }

            .message.info-message {
                background-color: #e2f2ff;
                color: #0056b3;
                border: 1px solid #b3e0ff;
            }

            .message.success-message {
                background-color: #d4edda;
                color: #155724;
                border: 1px solid #c3e6cb;
            }

            .message.error-message {
                background-color: #f8d7da;
                color: #721c24;
                border: 1px solid #f5c6cb;
            }
        </style>
    </th:block>
</head>
<body>
<th:block layout:fragment="page_title">Quản lý Xe & Khách hàng</th:block>
<div layout:fragment="content">
    <div class="container">
        <h1>Danh sách Xe và Khách hàng</h1>

        <input type="text" id="searchInput" placeholder="Tìm kiếm theo biển số, hãng xe, tên khách hàng, SĐT...">

        <div id="message" class="message" style="display: none;"></div>

        <table>
            <thead>
            <tr>
                <th>Biển số xe</th>
                <th>Hãng xe</th>
                <th>Dòng xe</th>
                <th>Năm</th>
                <th>Tên khách hàng</th>
                <th>Email</th>
                <th>Số điện thoại</th>
                <th>Lần sửa gần nhất</th>
            </tr>
            </thead>
            <tbody id="vehicleTableBody">
            </tbody>
        </table>
    </div>
</div>

<th:block layout:fragment="js_additional">
    <script th:inline="javascript">
        const USER_INFO_API = '/api/user/info';
        const VEHICLES_API = '/api/admin/vehicles';

        document.addEventListener('DOMContentLoaded', function () {
            const tableBody = document.getElementById('vehicleTableBody');
            const messageDiv = document.getElementById('message');
            const searchInput = document.getElementById('searchInput');

            let allVehicles = [];

            function showMessage(msg, type = 'info', clearTable = false) {
                if (clearTable) {
                    tableBody.innerHTML = '';
                }
                messageDiv.textContent = msg;
                messageDiv.className = 'message ' + type + '-message';
                messageDiv.style.display = 'block';
            }

            // Hàm để định dạng ngày giờ
            function formatDateTime(isoString) {
                if (!isoString) return 'Chưa có';
                const date = new Date(isoString);
                return date.toLocaleDateString('vi-VN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });
            }

            // Hàm để render dữ liệu ra bảng
            function renderTable(data) {
                messageDiv.style.display = 'none'; // Ẩn thông báo khi có dữ liệu
                tableBody.innerHTML = ''; // Luôn xóa dữ liệu cũ trước khi render mới

                if (!data || data.length === 0) {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="8" style="text-align: center; color: #6c757d;">Không tìm thấy dữ liệu nào.</td>`;
                    tableBody.appendChild(noDataRow);
                    return;
                }

                data.forEach(vehicle => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${vehicle.licensePlate || 'N/A'}</td>
                        <td>${vehicle.brand || 'N/A'}</td>
                        <td>${vehicle.model || 'N/A'}</td>
                        <td>${vehicle.year || 'N/A'}</td>
                        <td>${vehicle.customerFullName || 'N/A'}</td>
                        <td>${vehicle.customerEmail || 'N/A'}</td>
                        <td>${vehicle.customerPhoneNumber || 'N/A'}</td>
                        <td>${formatDateTime(vehicle.lastRepairDate)}</td> `;
                    tableBody.appendChild(row);
                });
            }

            // Hàm gọi API để lấy dữ liệu xe
            async function fetchVehicles() {
                showMessage('Đang tải dữ liệu xe...', 'info');
                try {
                    const token = localStorage.getItem('jwtToken') || sessionStorage.getItem('jwtToken');
                    if (!token) {
                        showMessage('Bạn chưa đăng nhập hoặc phiên làm việc đã hết hạn. Vui lòng đăng nhập lại.', 'error', true);
                        setTimeout(() => { window.location.href = '/auth/login'; }, 2000);
                        return;
                    }

                    const response = await fetch(VEHICLES_API, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        allVehicles = await response.json();
                        renderTable(allVehicles); // Render dữ liệu
                        if (allVehicles.length > 0) {
                            showMessage('Tải dữ liệu xe thành công.', 'success');
                        } else {
                            showMessage('Không có dữ liệu xe để hiển thị.', 'info');
                        }
                    } else {
                        let errorMessage = `Lỗi khi tải dữ liệu xe: ${response.statusText}`;
                        try {
                            const errorData = await response.json();
                            if (errorData && errorData.message) {
                                errorMessage = errorData.message;
                            }
                        } catch (jsonError) {
                            console.warn('Could not parse error response as JSON:', jsonError);
                        }

                        showMessage(errorMessage, 'error', true);
                        console.error('Lỗi khi tải dữ liệu xe:', response.status, errorMessage);

                        if (response.status === 403) {
                            setTimeout(() => { window.location.href = '/admin/error/403'; }, 1500);
                        } else if (response.status === 401) {
                            setTimeout(() => { window.location.href = '/auth/login'; }, 1500);
                        }
                    }
                } catch (error) {
                    console.error('Lỗi mạng hoặc không thể kết nối đến máy chủ:', error);
                    showMessage('Lỗi mạng hoặc không thể kết nối đến máy chủ. Vui lòng thử lại sau.', 'error', true);
                }
            }

            // Hàm lọc dữ liệu dựa trên ô tìm kiếm
            function filterData() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                if (!searchTerm) {
                    renderTable(allVehicles);
                    return;
                }

                const filteredData = allVehicles.filter(vehicle => {
                    const searchableString = [
                        vehicle.licensePlate,
                        vehicle.brand,
                        vehicle.model,
                        vehicle.customerFullName,
                        vehicle.customerEmail,
                        vehicle.customerPhoneNumber,
                        formatDateTime(vehicle.lastRepairDate)
                    ].join(' ').toLowerCase();

                    return searchableString.includes(searchTerm);
                });

                renderTable(filteredData);
            }

            // --- Bắt đầu logic kiểm tra quyền ---
            async function checkUserRoleAndFetchVehicles() {
                showMessage('Đang kiểm tra quyền truy cập...', 'info');
                try {
                    const token = localStorage.getItem('jwtToken') || sessionStorage.getItem('jwtToken');
                    if (!token) {
                        showMessage('Bạn chưa đăng nhập hoặc phiên làm việc đã hết hạn. Vui lòng đăng nhập lại.', 'error', true);
                        setTimeout(() => { window.location.href = '/auth/login'; }, 2000);
                        return;
                    }

                    const response = await fetch(USER_INFO_API, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    const userInfoData = await response.json();

                    if (response.ok && userInfoData.success && userInfoData.data) {
                        const role = userInfoData.data.role;
                        if (role !== 'admin') {
                            showMessage('Bạn không có quyền truy cập trang này.', 'error', true);
                            setTimeout(() => { window.location.href = '/admin/error/403'; }, 1500); // Thêm setTimeout
                            return;
                        }
                        // Nếu là admin, tiến hành lấy dữ liệu xe
                        fetchVehicles();
                    } else {
                        // Xử lý trường hợp không lấy được thông tin người dùng hoặc API báo lỗi
                        const errorMessage = userInfoData.message || 'Không thể lấy thông tin người dùng. Vui lòng đăng nhập lại.';
                        showMessage(errorMessage, 'error', true);
                        setTimeout(() => { window.location.href = '/auth/login'; }, 2000);
                    }
                } catch (error) {
                    console.error('Lỗi khi kiểm tra thông tin người dùng:', error);
                    showMessage('Có lỗi xảy ra khi kiểm tra thông tin người dùng. Vui lòng thử lại sau.', 'error', true);
                    setTimeout(() => { window.location.href = '/auth/login'; }, 2000);
                }
            }
            // --- Kết thúc logic kiểm tra quyền ---

            // Gắn sự kiện cho ô tìm kiếm
            searchInput.addEventListener('input', filterData);

            // Bắt đầu quy trình kiểm tra quyền và sau đó lấy dữ liệu khi trang được tải
            checkUserRoleAndFetchVehicles();
        });
    </script>
</th:block>
</body>
</html>