<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Đặt lịch</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .form-control, .form-select {
            max-width: 500px;
        }
        .input-group {
            max-width: 500px;
        }
        .btn-primary {
            max-width: 200px;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>
<div class="container mt-4">
    <h1>Đặt lịch sửa xe</h1>
    <div th:if="${error}" class="alert alert-danger">
        <span th:text="${error}"></span>
    </div>
    <div th:if="${success}" class="alert alert-success">
        <span th:text="${success}"></span>
    </div>
    <form th:action="@{/appointment}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <div class="mb-3">
            <label for="serviceId" class="form-label">Chọn dịch vụ</label>
            <select class="form-control form-select" id="serviceId" name="serviceId" required>
                <option th:each="service : ${services}"
                        th:value="${service.id}"
                        th:text="${service.name} + ' '+ ${service.estimatedDurationMinutes}+ ' Phút'"></option>
            </select>
        </div>
        <div class="mb-3">
            <label for="date" class="form-label">Chọn ngày</label>
            <input type="date" class="form-control" id="date" name="date" required
                   min="2025-07-14" max="2025-12-31"/>
        </div>
        <div class="mb-3">
            <label for="time" class="form-label">Chọn giờ</label>
            <select class="form-control form-select" id="time" name="time" required>
                <option value="" disabled selected>Chọn giờ</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Đặt lịch</button>
    </form>
</div>

<!-- Modal thông báo lỗi -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">Thông báo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="errorModalBody">
                <!-- Nội dung lỗi sẽ được thêm bằng JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const dateInput = document.getElementById('date');
    const timeSelect = document.getElementById('time');
    const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
    const errorModalBody = document.getElementById('errorModalBody');

    // Hàm tạo danh sách giờ hợp lệ
    function populateTimeOptions(selectedDate) {
        timeSelect.innerHTML = '<option value="" disabled selected>Chọn giờ</option>';
        const day = selectedDate.getDay();
        let startHour, endHour;

        // Chủ nhật nghỉ
        if (day === 0) {
            showErrorModal('Chủ nhật tiệm nghỉ. Vui lòng chọn ngày khác.');
            dateInput.value = '';
            return;
        }
        // Thứ 7: 08:00 - 12:00
        else if (day === 6) {
            startHour = 8;
            endHour = 12;
        }
        // Thứ 2-6: 08:00 - 20:00
        else {
            startHour = 8;
            endHour = 20;
        }

        // Tạo các mốc 00, 20, 40 phút
        for (let hour = startHour; hour < endHour; hour++) {
            for (let minute of [0, 20, 40]) {
                const time = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                const option = document.createElement('option');
                option.value = time;
                option.text = time;
                timeSelect.appendChild(option);
            }
        }
    }

    // Hàm hiển thị modal lỗi
    function showErrorModal(message) {
        errorModalBody.textContent = message;
        errorModal.show();
    }

    // Xử lý khi chọn ngày
    dateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        if (this.value) {
            populateTimeOptions(selectedDate);
        } else {
            timeSelect.innerHTML = '<option value="" disabled selected>Chọn giờ</option>';
        }
    });

    // Xử lý khi chọn giờ
    timeSelect.addEventListener('change', function() {
        const selectedDate = new Date(dateInput.value);
        const day = selectedDate.getDay();
        const [hours, minutes] = this.value.split(':').map(Number);

        if (day === 0) {
            showErrorModal('Chủ nhật tiệm nghỉ. Vui lòng chọn ngày khác.');
            dateInput.value = '';
            this.value = '';
        } else if (day === 6 && (hours >= 12)) {
            showErrorModal('Thứ 7 chỉ làm việc từ 08:00 đến 12:00.');
            this.value = '';
        } else if (day >= 1 && day <= 5 && (hours < 8 || hours >= 20)) {
            showErrorModal('Thời gian làm việc từ 08:00 đến 20:00.');
            this.value = '';
        } else if (minutes % 20 !== 0) {
            showErrorModal('Vui lòng chọn giờ theo mốc 20 phút (VD: 08:00, 08:20, 08:40).');
            this.value = '';
        }
    });
</script>
</body>
</html>