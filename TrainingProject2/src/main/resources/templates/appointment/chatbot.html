<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Dịch Vụ Sửa Xe Máy</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-container {
            /* Kích thước nhỏ gọn cho cửa sổ */
            height: 480px;
            width: 350px;
        }
        .chat-history {
            height: calc(100% - 7rem);
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            border-bottom-right-radius: 0;
        }
        .bot-message {
            background-color: #e5e7eb;
            color: #1f2937;
            border-bottom-left-radius: 0;
        }
        .typing-indicator span {
            animation: bounce 0.8s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>
<body class="bg-gray-100">

<!-- Nút biểu tượng chat -->
<button id="chat-icon" class="fixed bottom-4 left-4 bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-blue-700 transition-all z-50">
    <i class="fas fa-comment-alt text-2xl"></i>
</button>

<!-- Cửa sổ chatbot -->
<div id="chat-window-container" class="fixed bottom-20 left-4 hidden z-50">
    <div class="chat-container w-full bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
        <!-- Tiêu đề Chat -->
        <div class="bg-gray-800 text-white p-4 flex items-center justify-between rounded-t-xl">
            <div class="flex items-center space-x-3">
                <i class="fas fa-motorcycle text-indigo-400 text-xl"></i>
                <h1 class="text-xl font-semibold">Trợ lý Sửa xe</h1>
            </div>
            <!-- Nút đóng cửa sổ -->
            <button id="close-chat" class="text-white hover:text-gray-300 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Lịch sử Chat -->
        <div id="chat-history" class="chat-history p-4 space-y-4 overflow-y-auto custom-scrollbar">
            <!-- Tin nhắn khởi đầu của bot -->
            <div class="flex justify-start">
                <div class="bot-message max-w-xs md:max-w-md p-3 rounded-lg shadow-md">
                    Chào bạn! Hãy cho tôi biết xe của bạn đang gặp vấn đề gì. Ví dụ: "Xe tôi bị yếu đèn", "Phanh không ăn" hoặc "Đã lâu rồi chưa bảo dưỡng".
                </div>
            </div>
        </div>

        <!-- Ô nhập liệu Chat -->
        <div class="p-4 border-t border-gray-200 rounded-b-xl">
            <div id="typing-indicator" class="hidden flex items-center space-x-1 text-gray-400 text-sm mb-2 ml-2">
                <span class="typing-indicator-dot">.</span>
                <span class="typing-indicator-dot">.</span>
                <span class="typing-indicator-dot">.</span>
            </div>
            <div class="flex items-center space-x-3">
                <input type="text" id="user-input" placeholder="Nhập tin nhắn của bạn..." class="flex-1 p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                <button id="send-btn" class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg hover:bg-blue-700 transition-all">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatIcon = document.getElementById('chat-icon');
        const chatWindowContainer = document.getElementById('chat-window-container');
        const closeChatBtn = document.getElementById('close-chat');
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');

        const API_KEY = "";

        // Hàm bật/tắt cửa sổ chatbot
        const toggleChatWindow = () => {
            chatWindowContainer.classList.toggle('hidden');
        };

        /**
         * Thêm tin nhắn vào lịch sử chat.
         * @param {string} text Nội dung tin nhắn.
         * @param {string} sender 'user' (người dùng) hoặc 'bot'.
         */
        const addMessage = (text, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'mb-2');
            if (sender === 'user') {
                messageDiv.classList.add('justify-end');
                messageDiv.innerHTML = `<div class="user-message max-w-xs md:max-w-md p-3 rounded-lg shadow-md">${text}</div>`;
            } else {
                messageDiv.classList.add('justify-start');
                messageDiv.innerHTML = `<div class="bot-message max-w-xs md:max-w-md p-3 rounded-lg shadow-md">${text}</div>`;
            }
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        };

        /**
         * Lấy gợi ý dịch vụ từ API Gemini.
         * @param {string} userPrompt Mô tả vấn đề của người dùng.
         * @returns {Promise<string>} Phản hồi của chatbot.
         */
        const fetchServiceSuggestions = async (userPrompt) => {
            const prompt = `Bạn là một trợ lý ảo chuyên nghiệp và thân thiện của một tiệm sửa xe máy. Khách hàng sẽ mô tả vấn đề của họ. Nhiệm vụ của bạn là lắng nghe, đưa ra một câu trả lời ngắn gọn, thân thiện và gợi ý một hoặc một vài dịch vụ phù hợp nhất từ danh sách sau:
            - Thay nhớt
            - Thay bugi
            - Sửa phanh
            - Bảo dưỡng
            - Rửa xe

            Nếu vấn đề không rõ ràng, hãy trả lời một cách thân thiện và gợi ý dịch vụ "Kiểm tra tổng quát" để khách hàng mang xe đến.
            Không nói rằng bạn là một AI.
            Luôn luôn trả lời bằng tiếng Việt.

            Ví dụ:
            Khách hàng: "Xe tôi kêu lách cách ở động cơ."
            Bạn: "Chào bạn, tiếng kêu lạ ở động cơ có thể do nhiều nguyên nhân. Bạn có thể tham khảo dịch vụ "Bảo dưỡng" để chúng tôi kiểm tra và xác định chính xác vấn đề nhé."

            Khách hàng: "Xe tôi vào số khó khăn."
            Bạn: "Chào bạn, vấn đề vào số khó có thể liên quan đến hộp số hoặc bộ phận truyền động. Để chúng tôi kiểm tra chi tiết, bạn có thể tham khảo dịch vụ "Kiểm tra tổng quát" nhé."

            Khách hàng: "${userPrompt}"
            Bạn: `;

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            console.warn(`Lỗi: Quá nhiều yêu cầu. Đang thử lại trong ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            attempts++;
                            continue;
                        }
                        const errorData = await response.json();
                        throw new Error(`Lỗi API: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                    }

                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    return text || "Xin lỗi, tôi không hiểu vấn đề của bạn. Bạn có thể mô tả chi tiết hơn không?";

                } catch (error) {
                    console.error('Lỗi khi gọi API Gemini:', error);
                    return "Rất tiếc, đã có lỗi xảy ra. Vui lòng thử lại sau.";
                }
            }
            return "Rất tiếc, đã có lỗi xảy ra. Vui lòng thử lại sau.";
        };

        const handleSend = async () => {
            const userMessage = userInput.value.trim();
            if (userMessage === '') return;

            // Hiển thị tin nhắn người dùng
            addMessage(userMessage, 'user');
            userInput.value = '';

            // Hiện biểu tượng đang gõ
            typingIndicator.classList.remove('hidden');

            // Lấy phản hồi từ bot
            const botResponse = await fetchServiceSuggestions(userMessage);

            // Ẩn biểu tượng đang gõ và hiển thị tin nhắn bot
            typingIndicator.classList.add('hidden');
            addMessage(botResponse, 'bot');
        };

        // Lắng nghe sự kiện
        chatIcon.addEventListener('click', toggleChatWindow);
        closeChatBtn.addEventListener('click', toggleChatWindow);
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                handleSend();
            }
        });
    });
</script>

</body>
</html>
