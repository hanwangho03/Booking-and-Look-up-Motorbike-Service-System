<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thống kê</title>
  <!-- Favicon -->
  <link rel="shortcut icon" th:href="@{/assets/img/favicon.svg}">
  <!-- Bootstrap min.css -->
  <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
  <!-- All Min Css -->
  <link rel="stylesheet" th:href="@{/assets/css/all.min.css}">
  <!-- Animate.css -->
  <link rel="stylesheet" th:href="@{/assets/css/animate.css}">
  <!-- Magnific Popup.css -->
  <link rel="stylesheet" th:href="@{/assets/css/magnific-popup.css}">
  <!-- MeanMenu.css -->
  <link rel="stylesheet" th:href="@{/assets/css/meanmenu.css}">
  <!-- Swiper Bundle.css -->
  <link rel="stylesheet" th:href="@{/assets/css/swiper-bundle.min.css}">
  <!-- Nice Select.css -->
  <link rel="stylesheet" th:href="@{/assets/css/nice-select.css}">
  <!-- Icomon.css -->
  <link rel="stylesheet" th:href="@{/assets/css/icomon.css}">
  <!-- Main.css -->
  <link rel="stylesheet" th:href="@{/assets/css/main.css}">
  <!-- Thêm Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .bg-cover{
      margin-bottom: 20px;
    }
    .chart-container {
      width: 80%;
      margin: auto;
      margin-top: 40px;
    }
    .chart-title {
      text-align: center;
      margin-bottom: 20px;
      font-size: 1.8rem;
      color: #333;
    }
    .month-selector {
      text-align: center;
      margin-top: 20px;
      margin-bottom: 30px;
    }
    .chart-container{
      margin-bottom: 50px;
    }
  </style>
  <!-- Font Awesome for icons -->
  <!-- Script để fix lỗi preloader -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const preloader = document.getElementById('preloader');
      if (preloader) {
        preloader.classList.add('hide-preloader');
        preloader.addEventListener('transitionend', () => {
          preloader.remove();
        });
      }
    });
  </script>

  <!-- === BẮT ĐẦU: ĐÃ DI CHUYỂN TẤT CẢ JS LÊN ĐÂY ĐỂ DROPDOWN HOẠT ĐỘNG === -->
  <!--<< All JS Plugins >>-->
  <script th:src="@{/assets/js/jquery-3.7.1.min.js}"></script>
  <!--<< Viewport Js >>-->
  <script th:src="@{/assets/js/viewport.jquery.js}"></script>
  <!--<< Bootstrap Js >>-->
  <script th:src="@{/assets/js/bootstrap.bundle.min.js}"></script>
  <!--<< nice-selec Js >>-->
  <script th:src="@{/assets/js/jquery.nice-select.min.js}"></script>
  <!--<< Waypoints Js >>-->
  <script th:src="@{/assets/js/jquery.waypoints.js}"></script>
  <!--<< Counterup Js >>-->
  <script th:src="@{/assets/js/jquery.counterup.min.js}"></script>
  <!--<< Swiper Slider Js >>-->
  <script th:src="@{/assets/js/swiper-bundle.min.js}"></script>
  <!--<< MeanMenu Js >>-->
  <script th:src="@{/assets/js/jquery.meanmenu.min.js}"></script>
  <!--<< Magnific Popup Js >>-->
  <script th:src="@{/assets/js/jquery.magnific-popup.min.js}"></script>
  <!--<< Wow Animation Js >>-->
  <script th:src="@{/assets/js/wow.min.js}"></script>
  <!--<< Main.js >>-->
  <script th:src="@{/assets/js/main.js}"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <!-- === KẾT THÚC: CÁC SCRIPT ĐÃ ĐƯỢC DI CHUYỂN === -->

</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
  <!-- GT Breadcrumb Section Start -->
  <div class="gt-breadcrumb-wrapper bg-cover" th:style="'background-image: url(' + @{/assets/img/breadcrumb-bg.jpg} + ');'">
    <div class="gt-right-shape"><img th:src="@{/assets/img/breadcrumb-shape.jpg}" alt="img"></div>
    <div class="container">
      <div class="gt-page-heading">
        <div class="gt-breadcrumb-sub-title">
          <h1 class="wow fadeInUp" data-wow-delay=".3s">Thống kê Lịch hẹn & Khối lượng công việc</h1>
        </div>
        <ul class="gt-breadcrumb-items wow fadeInUp" data-wow-delay=".5s">
          <li><a href="index.html">Trang Chủ</a></li>
          <li><i class="fa-solid fa-chevron-right"></i></li>
          <li>Thống kê Lịch hẹn & Khối lượng công việc</li>
        </ul>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="chart-container">
        <h2 class="chart-title">Số lượng lịch hẹn theo tuần</h2>
        <canvas id="weeklyAppointmentsChart"></canvas>
      </div>
    </div>
  </div>

  <hr class="my-5">

  <div class="row">
    <div class="col-md-12">
      <div class="month-selector">
        <a th:href="@{/admin/statistics(monthOffset=${monthOffset - 1})}" class="btn btn-outline-primary me-3">
          &laquo; Tháng trước
        </a>
        <span class="fw-bold fs-4 text-primary" th:text="${currentMonthYear}"></span>
        <a th:href="@{/admin/statistics(monthOffset=${monthOffset + 1})}" class="btn btn-outline-primary ms-3">
          Tháng sau &raquo;
        </a>
      </div>
      <div class="chart-container">
        <h2 class="chart-title">Khối lượng công việc của Kỹ thuật viên theo tháng</h2>
        <canvas id="technicianWorkloadChart"></canvas>
      </div>
    </div>
  </div>

</div>
<div th:replace="~{fragments/footer :: footer}"></div>

<script th:inline="javascript">
  /*<![CDATA[*/

  // Dữ liệu từ controller cho biểu đồ theo tuần
  const weeklyLabels = /*[[${weeklyLabels}]]*/ [];
  const weeklyData = /*[[${weeklyData}]]*/ [];

  // Dữ liệu từ controller cho biểu đồ khối lượng công việc của kỹ thuật viên
  const technicianNames = /*[[${technicianNames}]]*/ [];
  const workloadCounts = /*[[${workloadCounts}]]*/ [];

  // --- Biểu đồ số lượng lịch hẹn theo tuần ---
  const weeklyCtx = document.getElementById('weeklyAppointmentsChart').getContext('2d');
  new Chart(weeklyCtx, {
    type: 'bar', // Hoặc 'line'
    data: {
      labels: weeklyLabels,
      datasets: [{
        label: 'Số lượng lịch hẹn',
        data: weeklyData,
        backgroundColor: 'rgba(54, 162, 235, 0.6)',
        borderColor: 'rgba(54, 162, 235, 1)',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Lịch hẹn được đặt hàng tuần',
          font: { size: 16 }
        },
        legend: {
          display: false
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: 'Số lượng lịch hẹn'
          }
        },
        x: {
          title: {
            display: true,
            text: 'Năm - Tuần'
          }
        }
      }
    }
  });

  // --- Biểu đồ khối lượng công việc của kỹ thuật viên theo tháng ---
  const technicianCtx = document.getElementById('technicianWorkloadChart').getContext('2d');
  new Chart(technicianCtx, {
    type: 'pie', // Hoặc 'bar'
    data: {
      labels: technicianNames,
      datasets: [{
        label: 'Số lượng lịch hẹn',
        data: workloadCounts,
        backgroundColor: [
          'rgba(255, 99, 132, 0.6)',
          'rgba(54, 162, 235, 0.6)',
          'rgba(255, 206, 86, 0.6)',
          'rgba(75, 192, 192, 0.6)',
          'rgba(153, 102, 255, 0.6)',
          'rgba(255, 159, 64, 0.6)'
        ],
        borderColor: [
          'rgba(255, 99, 132, 1)',
          'rgba(54, 162, 235, 1)',
          'rgba(255, 206, 86, 1)',
          'rgba(75, 192, 192, 1)',
          'rgba(153, 102, 255, 1)',
          'rgba(255, 159, 64, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'Phân bổ lịch hẹn giữa các kỹ thuật viên',
          font: { size: 16 }
        },
        legend: {
          position: 'top',
        }
      }
    }
  });

  /*]]>*/
</script>
</body>
</html>
