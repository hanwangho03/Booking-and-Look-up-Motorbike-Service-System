<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <!-- ========== Meta Tags ========== -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Pixel-plus">
    <meta name="description" content="CaroFix - Car Service & Repair HTML Template">
    <!-- ======== Page title ============ -->
    <title>CaroFix - Book a Service</title>
    <!--<< Favcion >>-->
    <link rel="shortcut icon" th:href="@{/assets/img/favicon.svg}">
    <!--<< Bootstrap min.css >>-->
    <link rel="stylesheet" th:href="@{/assets/css/bootstrap.min.css}">
    <!--<< All Min Css >>-->
    <link rel="stylesheet" th:href="@{/assets/css/all.min.css}">
    <!--<< Animate.css >>-->
    <link rel="stylesheet" th:href="@{/assets/css/animate.css}">
    <!--<< Magnific Popup.css >>-->
    <link rel="stylesheet" th:href="@{/assets/css/magnific-popup.css}">
    <!--<< MeanMenu.css >>-->
    <link rel="stylesheet" th:href="@{/assets/css/meanmenu.css}">
    <!--<< Swiper Bundle.css >>-->
    <link rel="stylesheet" th:href="@{/assets/css/swiper-bundle.min.css}">
    <!--<< Nice Select.css >>-->
    <link rel="stylesheet" th:href="@{/assets/css/nice-select.css}">
    <!--<< Icomon.css >>-->
    <link rel="stylesheet" th:href="@{/assets/css/icomon.css}">
    <!--<< Main.css >>-->
    <link rel="stylesheet" th:href="@{/assets/css/main.css}">
    <!-- Tailwind CSS (for new calendar only) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!--<< Custom CSS for Booking System and Chatbot Icon >>-->
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .ltb-section {
            padding: 60px 0;
        }
        .ltb-section-bg-white {
            background-color: #fff;
        }
        .ltb-section-bg-gray {
            background-color: #f8f8f8;
        }
        .ltb-header-descr {
            text-align: center;
            margin-bottom: 30px;
            color: #666;
        }
        .ltb-service-wrapper {
            margin-bottom: 30px;
        }
        .ltb-service {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .ltb-service:hover, .ltb-service.selected {
            border-color: #007bff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .ltb-service-icon {
            font-size: 40px;
            margin-bottom: 15px;
            color: #007bff;
        }
        .ltb-descr h6 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        .ltb-descr p {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }
        .ltb-service-icons {
            list-style: none;
            padding: 0;
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .ltb-service-icons li {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #333;
        }
        .ltb-service-icons .ltx-icon {
            margin-right: 5px;
            font-size: 16px;
        }
        .ltb-calendar-descr {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #666;
        }
        .header-subheader {
            text-align: center;
            margin-bottom: 30px;
        }
        .header-subheader .subheader {
            font-size: 14px;
            color: #007bff;
            margin-bottom: 10px;
        }
        .header-subheader .header {
            font-size: 24px;
            font-weight: bold;
        }
        .row-center {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
        }
        /* Calendar and Time Slot Styles */
        .day-cell.selected {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .time-slot {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .time-slot.selected {
            background-color: #007bff !important;
            color: white !important;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .disabled-day, .time-slot.disabled {
            color: #ccc !important;
            cursor: not-allowed;
            background-color: #f0f0f0 !important;
        }
        /* CSS cho hiệu ứng modal */
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .modal-content {
            animation: fadeIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        /* --- CSS cho Chatbot --- */
        .chat-container {
            height: 480px;
            width: 350px;
        }
        .chat-history {
            height: calc(100% - 7rem);
        }
        .user-message {
            background-color: #3b82f6;
            color: white;
            border-bottom-right-radius: 0;
        }
        .bot-message {
            background-color: #e5e7eb;
            color: #1f2937;
            border-bottom-left-radius: 0;
        }
        .typing-indicator span {
            animation: bounce 0.8s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-5px);
            }
        }
        #chat-window-container input {
            color: #111 !important;
            background-color: #fff !important;
        }
        #chat-window-container input::placeholder {
            color: #9ca3af !important;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<!-- GT Breadcrumb Section Start -->
<div class="gt-breadcrumb-wrapper bg-cover" style="background-image: url('/assets/img/breadcrumb-bg.jpg');">
    <div class="gt-right-shape"><img src="/assets/img/breadcrumb-shape.jpg" alt="img"></div>
    <div class="container">
        <div class="gt-page-heading">
            <div class="gt-breadcrumb-sub-title">
                <h1 class="wow fadeInUp" data-wow-delay=".3s">BOOK A SERVICE</h1>
            </div>
            <ul class="gt-breadcrumb-items wow fadeInUp" data-wow-delay=".5s">
                <li><a href="/home">Home</a></li>
                <li><i class="fa-solid fa-chevron-right"></i></li>
                <li>Book a Service</li>
            </ul>
        </div>
    </div>
</div>

<!-- GT Booking Section Start -->
<section class="ltb-section ltb-step-03 ltb-section-bg-white">
    <div class="container">
        <div class="heading header-subheader align-center subcolor-main has-subheader heading-tag-h4">
            <h6 class="subheader">Bước 01</h6>
            <h4 class="header">Chọn Dịch Vụ</h4>
        </div>
        <div class="ltb-header-descr">Vui lòng chọn dịch vụ mà bạn muốn đặt lịch.</div>

        <!-- Services will be populated here by Thymeleaf -->
        <div class="row row-center" id="service-list">
            <div th:each="service : ${services}" class="col-lg-4 col-md-6 col-sm-6 ltb-service-wrapper">
                <div data-mh="ltb-services-item" class="ltb-service"
                     th:data-service-id="${service.id}"
                     th:data-service-title="${service.name}"
                     th:data-service-duration="${service.estimatedDurationMinutes}">
                    <div class="ltb-service-icon"><span class="ltx-icon fas fa-car-wrench"></span></div>
                    <div class="ltb-descr">
                        <h6 class="header" th:text="${service.name}"></h6>
                        <p class="descr" th:text="'Thời gian: ' + ${service.estimatedDurationMinutes} + ' phút'"></p>
                        <ul class="ltb-service-icons">
                            <li><span class="ltx-icon fas fa-history"></span><span th:text="${service.estimatedDurationMinutes}"></span> min</li>
                            <li><span class="ltx-icon fas fa-wallet"></span><span class="ltb-currency ltb-currency-before">$</span></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- GT Booking Section Start - NEW CALENDAR -->
<section class="ltb-section ltb-step-04 ltb-section-bg-white">
    <div class="container mx-auto p-4 max-w-5xl">
        <div class="heading header-subheader text-center mb-8">
            <h6 class="text-sm text-blue-500 mb-2">Bước 02</h6>
            <h4 class="text-2xl font-bold">Chọn Ngày và Giờ</h4>
        </div>

        <div class="bg-gray-50 border rounded-lg shadow-lg p-6 flex flex-col md:flex-row gap-8">
            <!-- Calendar View -->
            <div class="w-full md:w-1/2 flex flex-col">
                <div class="flex items-center justify-between mb-4">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                        </svg>
                    </button>
                    <span id="current-month-year" class="font-semibold text-lg text-gray-800"></span>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </button>
                </div>

                <div class="grid grid-cols-7 gap-2 text-center text-sm font-medium text-gray-500">
                    <span>T2</span>
                    <span>T3</span>
                    <span>T4</span>
                    <span>T5</span>
                    <span>T6</span>
                    <span>T7</span>
                    <span>CN</span>
                </div>

                <div id="calendar-days" class="grid grid-cols-7 gap-2 text-center text-sm mt-2">
                    <!-- Days will be populated here -->
                </div>
            </div>

            <!-- Time Slots -->
            <div class="w-full md:w-1/2 flex flex-col">
                <div class="text-lg font-bold text-gray-800 mb-4" id="time-slots-header">
                    Chọn một ngày để xem giờ
                </div>
                <div id="time-slots" class="grid grid-cols-2 md:grid-cols-3 gap-2 overflow-y-auto max-h-[400px]">
                    <!-- Time slots will be populated here -->
                </div>
                <button id="confirm-booking-btn" class="mt-4 py-3 px-6 bg-blue-600 text-white font-bold rounded-lg shadow-md hover:bg-blue-700 transition duration-300 hidden">
                    Xác nhận đặt lịch
                </button>
            </div>
        </div>
    </div>
</section>

<!-- Modal thông báo đặt lịch -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookingModalLabel">Xác nhận đặt lịch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn đặt lịch với các thông tin sau:</p>
                <ul>
                    <li><strong id="modal-service-name">Dịch vụ:</strong></li>
                    <li><strong id="modal-date-time">Thời gian:</strong></li>
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="submit-booking-btn">Đặt lịch ngay</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thông báo kết quả -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-labelledby="resultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resultModalLabel">Thông báo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="resultMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Form ẩn để gửi dữ liệu đến Spring Boot Backend -->
<form id="booking-form" action="/appointment" method="post" style="display: none;">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
    <input type="hidden" name="serviceId" id="form-serviceId">
    <input type="hidden" name="date" id="form-date">
    <input type="hidden" name="time" id="form-time">
</form>

<!-- Server Messages for Success/Error -->
<div id="server-messages"
     th:if="${successMessage}"
     th:attr="data-message=${successMessage}, data-type='success'"
     style="display:none;">
</div>
<div id="server-messages"
     th:if="${errorMessage}"
     th:attr="data-message=${errorMessage}, data-type='error'"
     style="display:none;">
</div>

<!-- Modal Thông báo thành công -->
<div id="success-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
    <div class="modal-content w-full max-w-sm rounded-lg bg-white p-6 shadow-xl">
        <div class="flex flex-col items-center justify-center">
            <svg class="h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2l4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="mt-4 text-2xl font-bold text-gray-800">Đặt lịch thành công!</h2>
            <p id="success-message" class="mt-2 text-center text-gray-600"></p>
            <button id="close-success-modal" class="mt-6 rounded-md bg-green-500 px-6 py-2 font-semibold text-white transition duration-200 hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                Đóng
            </button>
        </div>
    </div>
</div>

<!-- Modal Thông báo lỗi -->
<div id="error-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
    <div class="modal-content w-full max-w-sm rounded-lg bg-white p-6 shadow-xl">
        <div class="flex flex-col items-center justify-center">
            <svg class="h-16 w-16 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <h2 class="mt-4 text-2xl font-bold text-gray-800">Lỗi!</h2>
            <p id="error-message" class="mt-2 text-center text-gray-600"></p>
            <button id="close-error-modal" class="mt-6 rounded-md bg-red-500 px-6 py-2 font-semibold text-white transition duration-200 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                Đóng
            </button>
        </div>
    </div>
</div>

<!-- Back to top button -->
<a href="#" id="scroll-top" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

<!-- Chatbot Icon -->
<button id="chat-icon" class="fixed bottom-4 left-4 bg-blue-600 text-white rounded-full w-14 h-14 flex items-center justify-center shadow-lg hover:bg-blue-700 transition-all z-50">
    <i class="fas fa-comment-alt text-2xl"></i>
</button>

<!-- Cửa sổ chatbot (ban đầu ẩn) -->
<div id="chat-window-container" class="fixed bottom-20 left-4 hidden z-50">
    <div class="chat-container w-full bg-white rounded-xl shadow-2xl flex flex-col overflow-hidden">
        <!-- Tiêu đề Chat -->
        <div class="bg-gray-800 text-white p-4 flex items-center justify-between rounded-t-xl">
            <div class="flex items-center space-x-3">
                <i class="fas fa-motorcycle text-indigo-400 text-xl"></i>
                <h1 class="text-xl font-semibold text-white">Trợ lý Sửa xe</h1>
            </div>
            <!-- Nút đóng cửa sổ -->
            <button id="close-chat" class="text-white hover:text-gray-300 transition-colors">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>

        <!-- Lịch sử Chat -->
        <div id="chat-history" class="chat-history p-4 space-y-4 overflow-y-auto custom-scrollbar">
            <!-- Tin nhắn khởi đầu của bot -->
            <div class="flex justify-start">
                <div class="bot-message max-w-xs md:max-w-md p-3 rounded-lg shadow-md">
                    Chào bạn! Hãy cho tôi biết xe của bạn đang gặp vấn đề gì. Ví dụ: "Xe tôi bị yếu đèn", "Phanh không ăn" hoặc "Đã lâu rồi chưa bảo dưỡng".
                </div>
            </div>
        </div>

        <!-- Ô nhập liệu Chat -->
        <div class="p-4 border-t border-gray-200 rounded-b-xl">
            <div id="typing-indicator" class="hidden flex items-center space-x-1 text-gray-400 text-sm mb-2 ml-2">
                <span class="typing-indicator-dot">.</span>
                <span class="typing-indicator-dot">.</span>
                <span class="typing-indicator-dot">.</span>
            </div>
            <div class="flex items-center space-x-3">
                <input type="text" id="user-input" placeholder="Nhập tin nhắn của bạn..." class="flex-1 p-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                <button id="send-btn" class="bg-blue-600 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg hover:bg-blue-700 transition-all">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- GT Footer Section Start -->
<footer class="gt-footer-section bg-cover fix" style="background-image: url('/assets/img/footer-bg.jpg');">
    <div class="container">
        <div class="gt-footer-widget-wrapper">
            <div class="row justify-content-between">
                <div class="col-xl-5 col-lg-6 col-md-12 wow fadeInUp" data-wow-delay=".2s">
                    <div class="gt-footer-widget-items">
                        <div class="gt-widget-head">
                            <a href="index.html" class="gt-footer-logo">
                                <img src="/assets/img/logo/white-logo.svg" alt="img">
                            </a>
                        </div>
                        <div class="gt-footer-content">
                            <p>
                                It is a long established fact that a reader will be distracted the road readable content of a page when looking at layout.
                            </p>
                            <div class="opening-hours-list">
                                <h4>Opening Hours</h4>
                                <ul class="opening-list">
                                    <li>
                                        Saturday - Tuesday
                                        <span>9:00 AM to 5:00 PM</span>
                                    </li>
                                    <li>
                                        Wednesday - Friday
                                        <span>10:00 AM to 4:00 PM</span>
                                    </li>
                                    <li>
                                        Sunday
                                        <span>Off Day</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-6 wow fadeInUp" data-wow-delay=".4s">
                    <div class="gt-footer-widget-items gt-footer-link">
                        <div class="gt-widget-head">
                            <h3 class="gt-widget-title">Quick Link</h3>
                        </div>
                        <div class="gt-footer-link-list">
                            <ul>
                                <li><a href="about.html">About Us</a></li>
                                <li><a href="service.html">Services</a></li>
                                <li><a href="team.html">Our Team</a></li>
                                <li><a href="project.html">Portfolio</a></li>
                                <li><a href="news.html">News & Blog</a></li>
                                <li><a href="contact.html">Contact Us</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-xl-2 col-lg-3 col-md-6 wow fadeInUp" data-wow-delay=".6s">
                    <div class="gt-footer-widget-items gt-footer-link">
                        <div class="gt-widget-head">
                            <h3 class="gt-widget-title">Useful Links</h3>
                        </div>
                        <div class="gt-footer-link-list">
                            <ul>
                                <li><a href="about.html">Privacy Policy</a></li>
                                <li><a href="service.html">Terms & Condition</a></li>
                                <li><a href="team.html">Support</a></li>
                                <li><a href="project.html">Disclaimer</a></li>
                                <li><a href="news.html">FAQ</a></li>
                                <li><a href="contact.html">Career</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-xl-3 col-lg-4 col-md-6 wow fadeInUp" data-wow-delay=".8s">
                    <div class="gt-footer-widget-items">
                        <div class="gt-widget-head">
                            <h3 class="gt-widget-title">Get In Touch</h3>
                        </div>
                        <div class="gt-footer-content gt-touch">
                            <p class="gt-address">
                                1154, W 23rd St, New York,
                                NY 10011, USA
                            </p>
                            <ul>
                                <li><a href="mailto:infoyour@gmail.com"><i class="fal fa-envelope"></i>infoyour@gmail.com</a></li>
                                <li><a href="tel:096-745-6674"><i class="fal fa-phone-alt"></i>096-745-6674</a></li>
                            </ul>
                        </div>
                        <div class="gt-social-icon d-flex align-items-center">
                            <a href="#"><i class="fab fa-facebook-f"></i></a>
                            <a href="#"><i class="fab fa-twitter"></i></a>
                            <a href="#"><i class="fab fa-vimeo-v"></i></a>
                            <a href="#"><i class="fab fa-pinterest-p"></i></a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="gt-copyright-wrapper">
        <div class="container">
            <div class="gt-copyright-content">
                <p class="gt-copyright-text">
                    © 2024 <a href="index.html">CaroFix</a> All Rights Reserved.
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- Scripts -->
<script src="/assets/js/jquery-3.7.1.min.js"></script>
<script src="/assets/js/viewport.jquery.js"></script>
<script src="/assets/js/bootstrap.bundle.min.js"></script>
<script src="/assets/js/jquery.nice-select.min.js"></script>
<script src="/assets/js/jquery.waypoints.js"></script>
<script src="/assets/js/jquery.counterup.min.js"></script>
<script src="/assets/js/swiper-bundle.min.js"></script>
<script src="/assets/js/jquery.meanmenu.min.js"></script>
<script src="/assets/js/jquery.magnific-popup.min.js"></script>
<script src="/assets/js/wow.min.js"></script>
<script src="/assets/js/main.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const successModal = document.getElementById('success-modal');
        const errorModal = document.getElementById('error-modal');
        const successMessageEl = document.getElementById('success-message');
        const errorMessageEl = document.getElementById('error-message');

        // Đọc thông báo từ data-attributes được Thymeleaf render
        const successMessageThymeleaf = document.querySelector('#server-messages[data-type="success"]')?.dataset.message;
        const errorMessageThymeleaf = document.querySelector('#server-messages[data-type="error"]')?.dataset.message;

        // Hiển thị modal nếu có thông báo
        if (successMessageThymeleaf && successMessageThymeleaf !== 'null') {
            successMessageEl.textContent = successMessageThymeleaf;
            successModal.classList.remove('hidden');
            successModal.classList.add('flex');
        } else if (errorMessageThymeleaf && errorMessageThymeleaf !== 'null') {
            errorMessageEl.textContent = errorMessageThymeleaf;
            errorModal.classList.remove('hidden');
            errorModal.classList.add('flex');
        }

        // Xử lý sự kiện đóng modal
        document.getElementById('close-success-modal').addEventListener('click', () => {
            successModal.classList.add('hidden');
            successModal.classList.remove('flex');
        });

        document.getElementById('close-error-modal').addEventListener('click', () => {
            errorModal.classList.add('hidden');
            errorModal.classList.remove('flex');
        });

        // Đóng modal khi click ra ngoài
        successModal.addEventListener('click', (e) => {
            if (e.target === successModal) {
                successModal.classList.add('hidden');
                successModal.classList.remove('flex');
            }
        });

        errorModal.addEventListener('click', (e) => {
            if (e.target === errorModal) {
                errorModal.classList.add('hidden');
                errorModal.classList.remove('flex');
            }
        });

        const months = ["Tháng 1", "Tháng 2", "Tháng 3", "Tháng 4", "Tháng 5", "Tháng 6", "Tháng 7", "Tháng 8", "Tháng 9", "Tháng 10", "Tháng 11", "Tháng 12"];
        const businessHours = {
            1: { start: 8, end: 20 }, // Thứ 2: 8h - 20h
            2: { start: 8, end: 20 }, // Thứ 3: 8h - 20h
            3: { start: 8, end: 20 }, // Thứ 4: 8h - 20h
            4: { start: 8, end: 20 }, // Thứ 5: 8h - 20h
            5: { start: 8, end: 20 }, // Thứ 6: 8h - 20h
            6: { start: 8, end: 12 }, // Thứ 7: 8h - 12h
            0: { start: null, end: null } // Chủ nhật: Nghỉ
        };

        const serviceList = document.getElementById('service-list');
        const currentMonthYear = document.getElementById('current-month-year');
        const calendarDays = document.getElementById('calendar-days');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const timeSlotsContainer = document.getElementById('time-slots');
        const timeSlotsHeader = document.getElementById('time-slots-header');
        const confirmBookingBtn = document.getElementById('confirm-booking-btn');

        // Modals
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
        const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
        const resultMessage = document.getElementById('resultMessage');

        // State
        let selectedService = null;
        let selectedDate = null;
        let selectedTime = null;
        let today = new Date();
        today.setHours(0, 0, 0, 0);
        let currentDate = new Date(today.getFullYear(), today.getMonth());

        // Handle Service Selection
        serviceList.addEventListener('click', (event) => {
            const serviceDiv = event.target.closest('.ltb-service');
            if (serviceDiv) {
                document.querySelectorAll('.ltb-service.selected').forEach(el => el.classList.remove('selected'));
                serviceDiv.classList.add('selected');
                selectedService = {
                    id: serviceDiv.dataset.serviceId,
                    name: serviceDiv.dataset.serviceTitle
                };
                console.log(`Dịch vụ đã chọn: ${selectedService.name}`);
            }
        });

        // Render Calendar
        const renderCalendar = (date) => {
            calendarDays.innerHTML = '';
            const year = date.getFullYear();
            const month = date.getMonth();
            currentMonthYear.textContent = `${months[month]} ${year}`;

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const startDay = (firstDayOfMonth.getDay() === 0 ? 6 : firstDayOfMonth.getDay() - 1);

            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                calendarDays.appendChild(emptyCell);
            }

            for (let i = 1; i <= lastDayOfMonth.getDate(); i++) {
                const day = new Date(year, month, i);
                const dayElement = document.createElement('div');
                dayElement.classList.add('day-cell', 'p-2', 'rounded-full', 'text-center');
                dayElement.textContent = i;
                dayElement.dataset.date = day.toISOString().split('T')[0];

                const dayOfWeek = day.getDay();
                if (day < today || dayOfWeek === 0) {
                    dayElement.classList.add('disabled-day');
                } else {
                    dayElement.classList.add('cursor-pointer', 'hover:bg-gray-200');
                    dayElement.addEventListener('click', () => {
                        document.querySelectorAll('.day-cell').forEach(el => el.classList.remove('selected'));
                        dayElement.classList.add('selected');
                        selectedDate = day;
                        renderTimeSlots(selectedDate);
                    });
                }

                calendarDays.appendChild(dayElement);
            }
        };

        const renderTimeSlots = (date) => {
            timeSlotsContainer.innerHTML = '';
            confirmBookingBtn.classList.add('hidden');
            selectedTime = null;

            const dayOfWeek = date.getDay();
            const hoursConfig = businessHours[dayOfWeek];

            if (hoursConfig.start !== null) {
                timeSlotsHeader.textContent = `Các giờ trống vào ngày ${date.getDate()}/${date.getMonth() + 1}`;
                const now = new Date();

                for (let hour = hoursConfig.start; hour < hoursConfig.end; hour++) {
                    for (let minute = 0; minute < 60; minute += 20) {
                        const timeSlot = new Date(date.getFullYear(), date.getMonth(), date.getDate(), hour, minute);

                        if (timeSlot > now) {
                            const slotElement = document.createElement('button');
                            slotElement.classList.add('time-slot', 'py-2', 'px-3', 'rounded-lg', 'bg-white', 'border', 'border-gray-300', 'text-gray-800', 'font-medium', 'hover:bg-blue-500', 'hover:text-white', 'transition', 'duration-150');
                            slotElement.textContent = `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
                            slotElement.dataset.time = slotElement.textContent;

                            slotElement.addEventListener('click', () => {
                                document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
                                slotElement.classList.add('selected');
                                selectedTime = slotElement.dataset.time;
                                confirmBookingBtn.classList.remove('hidden');
                            });
                            timeSlotsContainer.appendChild(slotElement);
                        }
                    }
                }
            } else {
                timeSlotsHeader.textContent = `Ngày này không có giờ làm việc.`;
                const closedMessage = document.createElement('p');
                closedMessage.classList.add('text-center', 'text-gray-500', 'p-4');
                closedMessage.textContent = 'Vui lòng chọn ngày khác.';
                timeSlotsContainer.appendChild(closedMessage);
            }
        };

        // Handle Confirm Booking Button
        confirmBookingBtn.addEventListener('click', () => {
            if (selectedService && selectedDate && selectedTime) {
                document.getElementById('modal-service-name').textContent = `Dịch vụ: ${selectedService.name}`;
                document.getElementById('modal-date-time').textContent = `Thời gian: ${selectedDate.toLocaleDateString('vi-VN')} lúc ${selectedTime}`;
                bookingModal.show();
            } else {
                resultMessage.textContent = "Vui lòng chọn đầy đủ Dịch vụ, Ngày và Giờ.";
                resultModal.show();
            }
        });

        // Handle Submit Booking Button inside the modal
        document.getElementById('submit-booking-btn').addEventListener('click', () => {
            bookingModal.hide();
            const serviceId = selectedService.id;
            const year = selectedDate.getFullYear();
            const month = (selectedDate.getMonth() + 1).toString().padStart(2, '0');
            const day = selectedDate.getDate().toString().padStart(2, '0');
            const date = `${year}-${month}-${day}`;
            const time = selectedTime;

            document.getElementById('form-serviceId').value = serviceId;
            document.getElementById('form-date').value = date;
            document.getElementById('form-time').value = time;

            document.getElementById('booking-form').submit();
        });

        // Event listeners cho nút chuyển tháng
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });
        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });

        // Initial render
        renderCalendar(currentDate);
    });
</script>

<!-- Scripts for the Chatbot -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const chatIcon = document.getElementById('chat-icon');
        const chatWindowContainer = document.getElementById('chat-window-container');
        const closeChatBtn = document.getElementById('close-chat');
        const chatHistory = document.getElementById('chat-history');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const typingIndicator = document.getElementById('typing-indicator');

        const API_KEY = "AIzaSyBDrnoYXJ_nANy84IW7Wbu8XiDHFldVZp4";

        // Hàm bật/tắt cửa sổ chatbot
        const toggleChatWindow = () => {
            chatWindowContainer.classList.toggle('hidden');
        };

        /**
         * Thêm tin nhắn vào lịch sử chat.
         * @param {string} text Nội dung tin nhắn.
         * @param {string} sender 'user' (người dùng) hoặc 'bot'.
         */
        const addMessage = (text, sender) => {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('flex', 'mb-2');
            if (sender === 'user') {
                messageDiv.classList.add('justify-end');
                messageDiv.innerHTML = `<div class="user-message max-w-xs md:max-w-md p-3 rounded-lg shadow-md">${text}</div>`;
            } else {
                messageDiv.classList.add('justify-start');
                messageDiv.innerHTML = `<div class="bot-message max-w-xs md:max-w-md p-3 rounded-lg shadow-md">${text}</div>`;
            }
            chatHistory.appendChild(messageDiv);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        };

        /**
         * Lấy gợi ý dịch vụ từ API Gemini.
         * @param {string} userPrompt Mô tả vấn đề của người dùng.
         * @returns {Promise<string>} Phản hồi của chatbot.
         */
        const fetchServiceSuggestions = async (userPrompt) => {
            const prompt = `Bạn là một trợ lý ảo chuyên nghiệp và thân thiện của một tiệm sửa xe máy. Khách hàng sẽ mô tả vấn đề của họ. Nhiệm vụ của bạn là lắng nghe, đưa ra một câu trả lời ngắn gọn, thân thiện và gợi ý một hoặc một vài dịch vụ phù hợp nhất từ danh sách sau:
            - Thay nhớt
            - Thay bugi
            - Sửa phanh
            - Bảo dưỡng
            - Rửa xe

            Nếu vấn đề không rõ ràng, hãy trả lời một cách thân thiện và gợi ý dịch vụ "Kiểm tra tổng quát" để khách hàng mang xe đến.
            Không nói rằng bạn là một AI.
            Luôn luôn trả lời bằng tiếng Việt.

            Ví dụ:
            Khách hàng: "Xe tôi kêu lách cách ở động cơ."
            Bạn: "Chào bạn, tiếng kêu lạ ở động cơ có thể do nhiều nguyên nhân. Bạn có thể tham khảo dịch vụ "Bảo dưỡng" để chúng tôi kiểm tra và xác định chính xác vấn đề nhé."

            Khách hàng: "Xe tôi vào số khó khăn."
            Bạn: "Chào bạn, vấn đề vào số khó có thể liên quan đến hộp số hoặc bộ phận truyền động. Để chúng tôi kiểm tra chi tiết, bạn có thể tham khảo dịch vụ "Kiểm tra tổng quát" nhé."

            Khách hàng: "${userPrompt}"
            Bạn: `;

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
            };

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;

            let attempts = 0;
            const maxAttempts = 5;
            let delay = 1000;

            while (attempts < maxAttempts) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            console.warn(`Lỗi: Quá nhiều yêu cầu. Đang thử lại trong ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2;
                            attempts++;
                            continue;
                        }
                        const errorData = await response.json();
                        throw new Error(`Lỗi API: ${response.status} ${response.statusText} - ${JSON.stringify(errorData)}`);
                    }

                    const result = await response.json();
                    const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                    return text || "Xin lỗi, tôi không hiểu vấn đề của bạn. Bạn có thể mô tả chi tiết hơn không?";

                } catch (error) {
                    console.error('Lỗi khi gọi API Gemini:', error);
                    return "Rất tiếc, đã có lỗi xảy ra. Vui lòng thử lại sau.";
                }
            }
            return "Rất tiếc, đã có lỗi xảy ra. Vui lòng thử lại sau.";
        };

        const handleSend = async () => {
            const userMessage = userInput.value.trim();
            if (userMessage === '') return;

            // Hiển thị tin nhắn người dùng
            addMessage(userMessage, 'user');
            userInput.value = '';

            // Hiện biểu tượng đang gõ
            typingIndicator.classList.remove('hidden');

            // Lấy phản hồi từ bot
            const botResponse = await fetchServiceSuggestions(userMessage);

            // Ẩn biểu tượng đang gõ và hiển thị tin nhắn bot
            typingIndicator.classList.add('hidden');
            addMessage(botResponse, 'bot');
        };

        // Lắng nghe sự kiện
        chatIcon.addEventListener('click', toggleChatWindow);
        closeChatBtn.addEventListener('click', toggleChatWindow);
        sendBtn.addEventListener('click', handleSend);
        userInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                handleSend();
            }
        });
    });
</script>